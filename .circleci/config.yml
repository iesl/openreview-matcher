# OpenReview Matcher CircleCI 2.0 configuration file 28
version: 2
jobs:
  build:
    working_directory: ~/
    docker:
      - image: cimg/python:3.9.17-node
      - image: cimg/redis:6.2.6
      - image: mongo:6.0
        command: [ --replSet, rs0 ]
      - image: docker.elastic.co/elasticsearch/elasticsearch:7.7.0
        environment:
          xpack.security.enabled: false
          transport.host: localhost
    steps:
      - checkout:
          path: ~/openreview-matcher-repo
      - run:
          name: Initialize Replica Set
          command: |
            sudo apt-get install gnupg curl
            curl -fsSL https://pgp.mongodb.com/server-6.0.asc | sudo gpg -o /usr/share/keyrings/mongodb-server-6.0.gpg --dearmor
            echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
            sudo apt-get update
            sudo apt-get upgrade -y
            sudo apt-get install -y mongodb-org=6.0.7 mongodb-org-database=6.0.7 mongodb-org-server=6.0.7 mongodb-org-mongos=6.0.7 mongodb-org-tools=6.0.7
            mongosh mongodb://localhost:27017 --eval "rs.initiate()"
      - run: git clone https://$OPENREVIEW_GITHUB@github.com/openreview/openreview-api-v1.git ~/openreview
      - run: git clone https://$OPENREVIEW_GITHUB@github.com/openreview/openreview-api.git ~/openreview-v2
      - run: git clone https://$OPENREVIEW_GITHUB@github.com/openreview/openreview-py.git ~/openreview-py
      - run:
          name: Create Directories
          command: |
            mkdir -p ~/openreview/logs
            mkdir -p ~/openreview/files/attachments
            mkdir -p ~/openreview/files/pdfs
            mkdir -p ~/openreview/files/temp
            mkdir -p ~/openreview-v2/logs
            mkdir -p ~/openreview-v2/files/attachments
            mkdir -p ~/openreview-v2/files/pdfs
            mkdir -p ~/openreview-v2/files/temp
      - run:
          # source: https://support.mozilla.org/en-US/kb/install-firefox-linux#w_system-firefox-installation-for-advanced-users
          # source: https://ubuntu-mate.community/t/firefox-installation-guide-non-snap/25299
          name: install firefox
          command: |
            wget "https://download.mozilla.org/?product=firefox-latest-ssl&os=linux64&lang=en-US" -O firefox-latest.tar.bz2
            tar xjf firefox-*.tar.bz2
            sudo mv firefox /opt
            sudo ln -s /opt/firefox/firefox /usr/local/bin/firefox
            sudo apt-get install libgtk-3-0
            sudo apt-get install libasound2
            sudo apt-get install libdbus-glib-1-2
            echo export PATH="$PATH:/usr/local/bin/firefox" >> ~/.bashrc
            source ~/.bashrc
      - run:
          name: setup virtual environment
          command: |
            python -m venv matcher
      - run:
          name: install dependencies
          command: |
            source matcher/bin/activate
            cd ~/openreview-matcher-repo
            pip install -e .
      - run:
          name: install the local openreview-py as a dependency
          command: |
            source matcher/bin/activate
            cd ~/openreview-matcher-repo
            pip install -e ~/openreview-py
      - run:
          name: install api-v1
          command: |
            cd ~/openreview
            npm install
      - run:
          name: run api-v1
          command: |
            source matcher/bin/activate
            cd ~/openreview
            NODE_ENV=circleci node scripts/clean_start_app.js
          background: true
      - run:
          name: install api-v2
          command: |
            cd ~/openreview-v2
            npm install
      - run:
          name: run api-v2
          command: |
            source matcher/bin/activate
            cd ~/openreview-v2
            NODE_ENV=circleci node scripts/setup_app.js
          background: true
      - run:
          shell: /bin/sh
          command: |
            wget --retry-connrefused --waitretry=1 --read-timeout=20 --timeout=15 -t 10 http://localhost:3000
            :
      - run:
          shell: /bin/sh
          command: |
            wget --retry-connrefused --waitretry=2 --read-timeout=20 --timeout=15 -t 20 http://localhost:3001
            :
      - run:
          name: run tests
          command: |
            source matcher/bin/activate
            cd ~/openreview-matcher-repo
            mkdir reports
            mkdir reports/pytest
            python -m pytest -x tests --junitxml=reports/pytest/pytest-report.xml
      # - run:
      #     name: run tests
      #     command: |
      #       source matcher/bin/activate
      #       cd ~/openreview-matcher-repo
      #       mkdir reports
      #       mkdir reports/pytest
      #       pytest --junitxml=reports/pytest/pytest-report.xml tests/test_interfaces.py
      - store_test_results:
          path: reports
      - store_artifacts:
          path: reports
